clear all
close all
clc
w=32;  %  chunk size for hilbert transform
fs = 40e3;fc = 20000;f  = 50;% f=frequency of message signal
tt = 0:(1/fs):( (3/f) - (5/fs) );
tt = tt(1,1:(w*(floor(length(tt)/w))) ); % time signal
wc=2*pi*fc;  % frequency of carrier
c  = 2*cos(wc*tt+pi/4); % carrier with phase offset
m2 = cos(2*pi*f*tt);    % message signal
sig = zeros(1,w);
yd  = zeros(1,w);
z   = zeros(1,w);
s1  = zeros(1,length(tt));
m1  = zeros(1,length(tt));
s3  = zeros(1,w);
kv = 1000;   % sensitivity of costas loop
phi1 = wc/fs;        % initial angle of vco
s2   = exp(-1i*phi1);   % initial value of  vco output 
%filter
num=[0.000119211282187877,0.000161329189731432,0.000222030336228187,0.000241281975887145,0.000175745555255468,-2.06166578667246e-05,-0.000387024524406765,-0.000943586713102416,-0.00168016361735705,-0.00254893436494767,-0.00346323373894975,-0.00430469535293835,-0.00493907551850226,-0.00523893821510886,-0.00510946203681789,-0.00451232924134778,-0.00348215406056563,-0.00213056217536513,-0.000635074456654835,0.000786955816595844,0.00191570779427956,0.00257096879585870,0.00265044505145706,0.00215558651296889,0.00119799275419015,-1.68581508005076e-05,-0.00122701475203162,-0.00216618170753433,-0.00262028228408657,-0.00247621052820555,-0.00175122210814794,-0.000594919464913651,0.000738497349662464,0.00194335571285871,0.00273048498685841,0.00289529658596338,0.00237010879777290,0.00124741957428203,-0.000233215092140269,-0.00173389970988935,-0.00289341368073966,-0.00341234332637116,-0.00312864127010130,-0.00206487713134075,-0.000433985007651521,0.00140056769484906,0.00300353696215649,0.00396907808554336,0.00402129819455589,0.00308974658731395,0.00133985204831176,-0.000852078204389154,-0.00297691216248247,-0.00450835309110400,-0.00503054914509469,-0.00434732461351757,-0.00254511728987454,8.89811392437614e-06,0.00273747882799671,0.00498026634564035,0.00614994031608877,0.00588148969556598,0.00413766461701197,0.00124175468804068,-0.00217549404233920,-0.00530805174706448,-0.00735938373753066,-0.00773866656638752,-0.00622150995657959,-0.00303343248521262,0.00117002675477024,0.00542962695112422,0.00869278535321889,0.0100636455298909,0.00903557852637349,0.00564862642004174,0.000527868328992726,-0.00521637913084755,-0.0102142942076426,-0.0131451753404531,-0.0130628661512250,-0.00966250456883382,-0.00342054377813575,0.00443632279462330,0.0121420600098830,0.0177504394421979,0.0195747053415383,0.0166164177699530,0.00888715922648522,-0.00245728910651126,-0.0152161394068743,-0.0264752754439338,-0.0331211011986134,-0.0324445918942135,-0.0227190009376605,-0.00363318247562191,0.0235146142052852,0.0559141670906234,0.0896278971016602,0.120201812304504,0.143395604774564,0.155898665050544,0.155898665050544,0.143395604774564,0.120201812304504,0.0896278971016602,0.0559141670906234,0.0235146142052852,-0.00363318247562191,-0.0227190009376605,-0.0324445918942135,-0.0331211011986134,-0.0264752754439338,-0.0152161394068743,-0.00245728910651126,0.00888715922648522,0.0166164177699530,0.0195747053415383,0.0177504394421979,0.0121420600098830,0.00443632279462330,-0.00342054377813575,-0.00966250456883382,-0.0130628661512250,-0.0131451753404531,-0.0102142942076426,-0.00521637913084755,0.000527868328992726,0.00564862642004174,0.00903557852637349,0.0100636455298909,0.00869278535321889,0.00542962695112422,0.00117002675477024,-0.00303343248521262,-0.00622150995657959,-0.00773866656638752,-0.00735938373753066,-0.00530805174706448,-0.00217549404233920,0.00124175468804068,0.00413766461701197,0.00588148969556598,0.00614994031608877,0.00498026634564035,0.00273747882799671,8.89811392437614e-06,-0.00254511728987454,-0.00434732461351757,-0.00503054914509469,-0.00450835309110400,-0.00297691216248247,-0.000852078204389154,0.00133985204831176,0.00308974658731395,0.00402129819455589,0.00396907808554336,0.00300353696215649,0.00140056769484906,-0.000433985007651521,-0.00206487713134075,-0.00312864127010130,-0.00341234332637116,-0.00289341368073966,-0.00173389970988935,-0.000233215092140269,0.00124741957428203,0.00237010879777290,0.00289529658596338,0.00273048498685841,0.00194335571285871,0.000738497349662464,-0.000594919464913651,-0.00175122210814794,-0.00247621052820555,-0.00262028228408657,-0.00216618170753433,-0.00122701475203162,-1.68581508005076e-05,0.00119799275419015,0.00215558651296889,0.00265044505145706,0.00257096879585870,0.00191570779427956,0.000786955816595844,-0.000635074456654835,-0.00213056217536513,-0.00348215406056563,-0.00451232924134778,-0.00510946203681789,-0.00523893821510886,-0.00493907551850226,-0.00430469535293835,-0.00346323373894975,-0.00254893436494767,-0.00168016361735705,-0.000943586713102416,-0.000387024524406765,-2.06166578667246e-05,0.000175745555255468,0.000241281975887145,0.000222030336228187,0.000161329189731432,0.000119211282187877];
s4  = zeros(1,length(num)); 
for n1  = 1:w:length(tt)
     cc  = c(1,(n1 ):(n1+w-1));% carrier
     m  = m2(1,(n1 ):(n1+w-1)); % message signal
     y  = cc.*m; % modulation
%% 64 point HILBERT TRANASFORM
        u1   = dctmtx(w);    % 64*64 matrix of discrete cosine transform
        u2   = dstmtx(w);    % 64*64 matrix of discrete cosine transform
        ht   = u2*u1*y';     % hilbert transform result
        s1(1,n1:(n1+w-1))  = y + 1i*ht';   % analytical signal
%% costas
        for n2  = n1:( n1 + w - 1 )
             s3 = s1(1,n2)*s2; % phase detector
             s4(1,1) = (( real(s3) )*( imag(s3) )); % real part * imaginary part
             m1(1,n2)=-real(s3);  % demodulated message signal
             
             % vectorization can beused easile instead of these two loops in matlab 
             % loop for convolution sum
             s5 = 0;%output of filter
             for n3 = 1:length(num)
                 s5 = s5 + (num(1,n3))*s4(1,n3);
             end 
             % loop for shifting operation in convolution
             for n3 = length(num):2
                 s4(1,n3)=s4(1,(n3-1));
             end
            
             phi = phi1 + (wc/fs) +(kv*s5/fs); % phase calculation for vco
             s2=exp(-1i*phi);  % vco output
             phi1=phi;         % saving value of phase for next iteration
        
        end
end
 
 subplot(311)
 plot(tt,m2)
 title('message signal')
 subplot(312)
 plot(tt,real(s1))
 title('modulated signal')
 subplot(313)
 plot(tt,m1)
 
 title('demodulated signal')